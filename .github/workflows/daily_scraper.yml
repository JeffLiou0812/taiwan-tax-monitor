name: Daily Tax Monitor

on:
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = Taiwan 02:00 AM
  workflow_dispatch:      # Manual trigger
  push:
    branches: [ main ]

permissions:
  contents: write
  actions: read

jobs:
  collect-tax-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas lxml chardet openpyxl

    - name: Create data directory
      run: mkdir -p data

    - name: Run tax collector
      id: collector
      run: |
        echo "=== Running Taiwan Tax Collector ==="
        python scripts/taiwan_tax_collector.py
        echo "=== Running MOF Scraper ==="
        python scripts/mof_scraper.py

    - name: List collected data
      if: always()
      run: |
        echo "=== Data directory contents ==="
        ls -la data/ 2>/dev/null || echo "No data directory"
        echo "=== Sample data content ==="
        cat data/*.json 2>/dev/null | head -50 || echo "No JSON files"

    - name: Upload collected data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tax-data-${{ github.run_number }}
        path: data/
        retention-days: 30
        if-no-files-found: warn

    - name: Create summary
      if: always()
      run: |
        echo "## 台灣稅務監控執行摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **執行時間**: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S') (台灣時間)" >> $GITHUB_STEP_SUMMARY
        echo "- **執行編號**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **觸發方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -d "data" ]; then
          FILE_COUNT=$(ls -1 data/*.json 2>/dev/null | wc -l)
          echo "- **收集檔案數**: ${FILE_COUNT} 個 JSON 檔案" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 收集的檔案" >> $GITHUB_STEP_SUMMARY
          ls -1 data/*.json 2>/dev/null | while read f; do echo "- \`$(basename $f)\`" >> $GITHUB_STEP_SUMMARY; done
        else
          echo "- **狀態**: 無資料目錄" >> $GITHUB_STEP_SUMMARY
        fi
